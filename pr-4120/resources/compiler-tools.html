

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Anaconda compiler tools &mdash; conda-build 3.20.5+16.gf0b2477.dirty documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/conda-logo.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Defining metadata (meta.yaml)" href="define-metadata.html" />
    <link rel="prev" title="Build scripts (build.sh, bld.bat)" href="build-scripts.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> conda-build
          

          
          </a>

          
            
            
              <div class="version">
                3.20.5+16.gf0b2477.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install-conda-build.html">Installing and updating conda-build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Resources</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="build-scripts.html">Build scripts (build.sh, bld.bat)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Anaconda compiler tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compiler-packages">Compiler packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-compiler-packages">Using the compiler packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#macos-sdk">macOS SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backward-compatibility">Backward compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#anaconda-compilers-and-conda-build-3">Anaconda compilers and conda-build 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#an-aside-on-cmake-and-sysroots">An aside on CMake and sysroots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customizing-the-compilers">Customizing the compilers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-your-customized-compiler-package-with-conda-build-3">Using your customized compiler package with conda-build 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#anaconda-compilers-implicitly-add-rpath-pointing-to-the-conda-environment">Anaconda compilers implicitly add RPATH pointing to the conda environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="define-metadata.html">Defining metadata (meta.yaml)</a></li>
<li class="toctree-l2"><a class="reference internal" href="link-scripts.html">Adding pre-link, post-link, and pre-unlink scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="activate-scripts.html">Activate scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="make-relocatable.html">Making packages relocatable</a></li>
<li class="toctree-l2"><a class="reference internal" href="package-spec.html">Conda package specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="use-shared-libraries.html">Using shared libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="variants.html">Build variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="commands/index.html">Conda-build CLI reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="add-win-start-menu-items.html">Adding Windows Start menu items</a></li>
<li class="toctree-l2"><a class="reference internal" href="style-guide.html">Writing style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-template.html">Tutorial template</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">conda-build</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Resources</a> &raquo;</li>
        
      <li>Anaconda compiler tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="anaconda-compiler-tools">
<span id="compiler-tools"></span><h1>Anaconda compiler tools<a class="headerlink" href="#anaconda-compiler-tools" title="Permalink to this headline">¶</a></h1>
<p>Anaconda 5.0 switched from OS-provided compiler tools to our own toolsets. This
allows improved compiler capabilities, including better security and
performance. This page describes how to use these tools and enable these
benefits.</p>
<div class="section" id="compiler-packages">
<h2>Compiler packages<a class="headerlink" href="#compiler-packages" title="Permalink to this headline">¶</a></h2>
<p>Before Anaconda 5.0, compilers were installed using system tools such as XCode
or <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">install</span> <span class="pre">gcc</span></code>. Now there are conda packages for Linux and macOS
compilers. Unlike the previous GCC 4.8.5 packages that included GCC, g++, and
GFortran all in the same package, these conda packages are split into separate
compilers:</p>
<p>macOS:</p>
<ul class="simple">
<li>clang_osx-64.</li>
<li>clangxx_osx-64.</li>
<li>gfortran_osx-64.</li>
</ul>
<p>Linux:</p>
<ul class="simple">
<li>gcc_linux-64.</li>
<li>gxx_linux-64.</li>
<li>gfortran_linux-64.</li>
</ul>
<p>A compiler's &quot;build platform&quot; is the platform where the compiler runs and
builds the code.</p>
<p>A compiler's &quot;host platform&quot; is the platform where the built code will finally
be hosted and run.</p>
<p>Notice that all of these package names end in a platform identifier which
specifies the host platform. All compiler packages are specific to both the
build platform and the host platform.</p>
</div>
<div class="section" id="using-the-compiler-packages">
<h2>Using the compiler packages<a class="headerlink" href="#using-the-compiler-packages" title="Permalink to this headline">¶</a></h2>
<p>The compiler packages can be installed with conda. Because they are designed
with (pseudo) cross-compiling in mind, all of the executables in a compiler
package are &quot;prefixed.&quot; Instead of <code class="docutils literal notranslate"><span class="pre">gcc</span></code>, the executable name of the compiler
you use will be something like <code class="docutils literal notranslate"><span class="pre">x86_64-conda_cos6-linux-gnu-gcc</span></code>. These full
compiler names are shown in the build logs, recording the host platform and
helping prevent the common mistake of using the wrong compiler.</p>
<p>Many build tools such as <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">CMake</span></code> search by default for a
compiler named simply <code class="docutils literal notranslate"><span class="pre">gcc</span></code>, so we set environment variables to point these
tools to the correct compiler.</p>
<p>We set these variables in conda <code class="docutils literal notranslate"><span class="pre">activate.d</span></code> scripts, so any environment in
which you will use the compilers must first be activated so the scripts will
run. Conda-build does this activation for you using activation hooks installed
with the compiler packages in <code class="docutils literal notranslate"><span class="pre">CONDA_PREFIX/etc/conda/activate.d</span></code>, so no
additional effort is necessary.</p>
<p>You can activate the root environment with the command <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">root</span></code>.</p>
</div>
<div class="section" id="macos-sdk">
<span id="mac-sdk"></span><h2>macOS SDK<a class="headerlink" href="#macos-sdk" title="Permalink to this headline">¶</a></h2>
<p>The macOS compilers require the macOS 10.9 SDK or above. The SDK license prevents
it from being bundled in the conda package. We know of 2 current sources for the
macOS SDKs:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/devernay/xcodelegacy">https://github.com/devernay/xcodelegacy</a></li>
<li><a class="reference external" href="https://github.com/phracker/MacOSX-SDKs">https://github.com/phracker/MacOSX-SDKs</a></li>
</ul>
<p>We usually install the 10.10 SDK at <code class="docutils literal notranslate"><span class="pre">/opt/MacOSX10.10.sdk</span></code> but you may install
it anywhere. Edit your <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file to point to it, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONDA_BUILD_SYSROOT</span><span class="p">:</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">MacOSX10</span><span class="o">.</span><span class="mf">10.</span><span class="n">sdk</span>        <span class="c1"># [osx]</span>
</pre></div>
</div>
<p>At Anaconda, we have this configuration setting in a centralized
<code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> at the root of our recipe repository. Since we run
build commands from that location, the file and the setting are used for all
recipes. The <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> search order is described further at
<a class="reference internal" href="variants.html#conda-build-variant-config-files"><span class="std std-ref">Creating conda-build variant config files</span></a>.</p>
<p>Build scripts for macOS should make use of the variables
<code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET</span></code> and <code class="docutils literal notranslate"><span class="pre">CONDA_BUILD_SYSROOT</span></code>, which are set by
conda-build (see <a class="reference internal" href="../user-guide/environment-variables.html#env-vars"><span class="std std-ref">Environment variables</span></a>). These variables should be translated into
correct compiler arguments, e.g. for Clang this would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>clang .. -isysroot ${CONDA_BUILD_SYSROOT} -mmacosx-version-min=${MACOSX_DEPLOYMENT_TARGET} ..
</pre></div>
</div>
<p>Most build tools, e.g. CMake and distutils (setuptools), will automatically pick
up <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET</span></code> but you need to pass <code class="docutils literal notranslate"><span class="pre">CONDA_BUILD_SYSROOT</span></code>
explicitly. For CMake, this can be done with the option
<code class="docutils literal notranslate"><span class="pre">-DCMAKE_OSX_SYSROOT=${CONDA_BUILD_SYSROOT}</span></code>. When building Python extensions
with distutils, one should always extend <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> before calling
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CFLAGS</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{CFLAGS}</span><span class="s2"> -i sysroot $</span><span class="si">{CONDA_BUILD_SYSROOT}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>When building C++ extensions with Cython, <code class="docutils literal notranslate"><span class="pre">CXXFLAGS</span></code> must be similarly modified.</p>
</div>
<div class="section" id="backward-compatibility">
<h2>Backward compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h2>
<p>Some users want to use the latest Anaconda packages but do not yet want to use
the Anaconda compilers. To enable this, the latest Python package builds have
a default <code class="docutils literal notranslate"><span class="pre">_sysconfigdata</span></code> file. This file sets the compilers provided by the
system, such as <code class="docutils literal notranslate"><span class="pre">gcc</span></code> and <code class="docutils literal notranslate"><span class="pre">g++</span></code>, as the default compilers. This way allows legacy
recipes to keep working.</p>
<p>Python packages also include an alternative <code class="docutils literal notranslate"><span class="pre">_sysconfigdata</span></code> file that sets
the Anaconda compilers as the default compilers. The Anaconda Python executable
itself is made with these Anaconda compilers.</p>
<p>The compiler packages set the environment variable
<code class="docutils literal notranslate"><span class="pre">_PYTHON_SYSCONFIGDATA_NAME</span></code>, which tells Python which <code class="docutils literal notranslate"><span class="pre">_sysconfigdata</span></code> file
to use. This variable is set at activation time using the activation hooks
described above.</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">_sysconfigdata</span></code> customization system is only present in recent
versions of the Python package. Conda-build automatically tries to use the
latest Python version available in the currently configured channels, which
normally gets the latest from the default channel. If you're using something
other than conda-build while working with the new compilers, conda does not
automatically update Python, so make sure you have the correct
<code class="docutils literal notranslate"><span class="pre">_sysconfigdata</span></code> files by updating your Python package manually.</p>
</div>
<div class="section" id="anaconda-compilers-and-conda-build-3">
<h2>Anaconda compilers and conda-build 3<a class="headerlink" href="#anaconda-compilers-and-conda-build-3" title="Permalink to this headline">¶</a></h2>
<p>The Anaconda 5.0 compilers and conda-build 3 are designed to work together.</p>
<p>Conda-build 3 defines a special jinja2 function, <code class="docutils literal notranslate"><span class="pre">compiler()</span></code>, to make it
easy to specify compiler packages dynamically on many platforms. The
<code class="docutils literal notranslate"><span class="pre">compiler</span></code> function takes at least 1 argument, the language of the compiler
to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">build</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">compiler</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>&quot;Cross-capable&quot; recipes can be used to make packages with a host platform
different than the build platform where conda-build runs. To write
cross-capable recipes, you may also need to use the &quot;host&quot; section in the
requirements section. In this example we set &quot;host&quot; to &quot;zlib&quot; to tell
conda-build to use the zlib in the conda environment and not the system
zlib. This makes sure conda-build uses the zlib for the host platform
and not the zlib for the build platform.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">build</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">compiler</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="p">}}</span>
  <span class="n">host</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">zlib</span>
</pre></div>
</div>
<p>Generally, the build section should include compilers and other build tools and
the host section should include everything else, including shared libraries,
Python, and Python libraries.</p>
</div>
<div class="section" id="an-aside-on-cmake-and-sysroots">
<h2>An aside on CMake and sysroots<a class="headerlink" href="#an-aside-on-cmake-and-sysroots" title="Permalink to this headline">¶</a></h2>
<p>Anaconda's compilers for Linux are built with something called crosstool-ng.
They include not only GCC, but also a &quot;sysroot&quot; with glibc, as well as the rest
of the toolchain (binutils). Ordinarily, the sysroot is something that your
system provides, and it is what establishes the libc compatibility bound for
your compiled code. Any compilation that uses a sysroot other than the system
sysroot is said to be &quot;cross-compiling.&quot; When the target OS and the build OS
are the same, it is called a &quot;pseudo-cross-compiler.&quot; This is the case for
normal builds with Anaconda's compilers on Linux.</p>
<p>Unfortunately, some software tools do not handle sysroots in intuitive ways.
CMake is especially bad for this. Even though the compiler itself understands
its own sysroot, CMake insists on ignoring that.  We've filed issues at:</p>
<ul class="simple">
<li><a class="reference external" href="https://gitlab.kitware.com/cmake/cmake/issues/17483">https://gitlab.kitware.com/cmake/cmake/issues/17483</a></li>
</ul>
<p>Additionally, this Stack Overflow issue has some more information: <a class="reference external" href="https://stackoverflow.com/questions/36195791/cmake-missing-sysroot-when-cross-compiling">https://stackoverflow.com/questions/36195791/cmake-missing-sysroot-when-cross-compiling</a></p>
<p>In order to teach CMake about the sysroot, you must do additional work. As an
example, please see our recipe for libnetcdf at
<a class="reference external" href="https://github.com/AnacondaRecipes/libnetcdf-feedstock/tree/master/recipe">https://github.com/AnacondaRecipes/libnetcdf-feedstock/tree/master/recipe</a></p>
<p>In particular, you'll need to copy the <code class="docutils literal notranslate"><span class="pre">cross-linux.cmake</span></code> file there, and reference it in your build.sh file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CMAKE_PLATFORM_FLAGS+=(-DCMAKE_TOOLCHAIN_FILE=&quot;${RECIPE_DIR}/cross-linux.cmake&quot;)

cmake -DCMAKE_INSTALL_PREFIX=${PREFIX} \
  ${CMAKE_PLATFORM_FLAGS[@]} \
  ${SRC_DIR}
</pre></div>
</div>
</div>
<div class="section" id="customizing-the-compilers">
<h2>Customizing the compilers<a class="headerlink" href="#customizing-the-compilers" title="Permalink to this headline">¶</a></h2>
<p>The compiler packages listed above are small packages that only include the
activation scripts and list most of the software they provide as runtime
dependencies.</p>
<p>This design is intended to make it easy for you to customize your own compiler
packages by copying these recipes and changing the flags. You can then edit the
<code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file to specify your own packages.</p>
<p>We have been careful to select good, general purpose, secure, and fast flags.
We have also used them for all packages in Anaconda Distribution 5.0.0, except
for some minor customizations in a few recipes. When changing these flags,
remember that choosing the wrong flags can reduce security, reduce performance,
and cause incompatibilities.</p>
<p>With that warning in mind, let's look at good ways to customize Clang.</p>
<ol class="arabic">
<li><p class="first">Download or fork the code from <a class="reference external" href="https://github.com/anacondarecipes/aggregate">https://github.com/anacondarecipes/aggregate</a>.
The Clang package recipe is in the <code class="docutils literal notranslate"><span class="pre">clang</span></code> folder. The main material is in the
llvm-compilers-feedstock folder.</p>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">clang/recipe/meta.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">clang_</span><span class="p">{{</span> <span class="n">target_platform</span> <span class="p">}}</span>
  <span class="n">version</span><span class="p">:</span> <span class="p">{{</span> <span class="n">version</span> <span class="p">}}</span>
</pre></div>
</div>
<p>The name here does not matter but the output names below do. Conda-build
expects any compiler to follow the BASENAME_PLATFORMNAME pattern, so it is
important to keep the <code class="docutils literal notranslate"><span class="pre">{{target_platform}}</span></code> part of the name.</p>
<p><code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">version</span> <span class="pre">}}</span></code> is left as an intentionally undefined jinja2 variable. It
is set later in <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code>.</p>
</li>
<li><p class="first">Before any packaging is done, run the build.sh script:
<a class="reference external" href="https://github.com/AnacondaRecipes/aggregate/blob/master/clang/build.sh">https://github.com/AnacondaRecipes/aggregate/blob/master/clang/build.sh</a></p>
<p>In this recipe, values are changed here. Those values are inserted into the
activate scripts that are installed later.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

CHOST=${macos_machine}

FINAL_CPPFLAGS=&quot;-D_FORTIFY_SOURCE=2 -mmacosx-version-min=${macos_min_version}&quot;
FINAL_CFLAGS=&quot;-march=core2 -mtune=haswell -mssse3 -ftree-vectorize -fPIC -fPIE -fstack-protector-strong -O2 -pipe&quot;
FINAL_CXXFLAGS=&quot;-march=core2 -mtune=haswell -mssse3 -ftree-vectorize -fPIC -fPIE -fstack-protector-strong -O2 -pipe -stdlib=libc++ -fvisibility-inlines-hidden -std=c++14 -fmessage-length=0&quot;
# These are the LDFLAGS for when the linker is being called directly, without &quot;-Wl,&quot;
FINAL_LDFLAGS=&quot;-pie -headerpad_max_install_names&quot;
# These are the LDFLAGS for when the linker is being driven by a compiler, with &quot;-Wl,&quot;
FINAL_LDFLAGS_CC=&quot;-Wl,-pie -Wl,-headerpad_max_install_names&quot;
FINAL_DEBUG_CFLAGS=&quot;-Og -g -Wall -Wextra -fcheck=all -fbacktrace -fimplicit-none -fvar-tracking-assignments&quot;
FINAL_DEBUG_CXXFLAGS=&quot;-Og -g -Wall -Wextra -fcheck=all -fbacktrace -fimplicit-none -fvar-tracking-assignments&quot;
FINAL_DEBUG_FFLAGS=&quot;-Og -g -Wall -Wextra -fcheck=all -fbacktrace -fimplicit-none -fvar-tracking-assignments&quot;

find &quot;${RECIPE_DIR}&quot; -name &quot;*activate*.sh&quot; -exec cp {} . \;

find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@CHOST@|${CHOST}|g&quot; &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@CPPFLAGS@|${FINAL_CPPFLAGS}|g&quot;             &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@CFLAGS@|${FINAL_CFLAGS}|g&quot;                 &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@DEBUG_CFLAGS@|${FINAL_DEBUG_CFLAGS}|g&quot;     &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@CXXFLAGS@|${FINAL_CXXFLAGS}|g&quot;             &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@DEBUG_CXXFLAGS@|${FINAL_DEBUG_CXXFLAGS}|g&quot; &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@DEBUG_CXXFLAGS@|${FINAL_DEBUG_CXXFLAGS}|g&quot; &quot;{}&quot; \;
# find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@FFLAGS@|${FINAL_FFLAGS}|g&quot;                 &quot;{}&quot; \;
# find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@DEBUG_FFLAGS@|${FINAL_DEBUG_FFLAGS}|g&quot;     &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@LDFLAGS@|${FINAL_LDFLAGS}|g&quot;               &quot;{}&quot; \;
find . -name &quot;*activate*.sh&quot; -exec sed -i.bak &quot;s|@LDFLAGS_CC@|${FINAL_LDFLAGS_CC}|g&quot;         &quot;{}&quot; \;
find . -name &quot;*activate*.sh.bak&quot; -exec rm &quot;{}&quot; \;
</pre></div>
</div>
</li>
<li><p class="first">With those changes to the activate scripts in place, it's time to move on to
installing things. Look back at the <code class="docutils literal notranslate"><span class="pre">clang</span></code> folder's <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code>. Here's
where we change the package name. Notice what comes before the
<code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">target_platform</span> <span class="pre">}}</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">super_duper_clang_</span><span class="p">{{</span> <span class="n">target_platform</span> <span class="p">}}</span>
    <span class="n">script</span><span class="p">:</span> <span class="n">install</span><span class="o">-</span><span class="n">clang</span><span class="o">.</span><span class="n">sh</span>
    <span class="n">requirements</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">clang</span> <span class="p">{{</span> <span class="n">version</span> <span class="p">}}</span>
</pre></div>
</div>
<p>The script reference here is another place you might add customization.
You'll either change the contents of those install scripts or change the
scripts that those install scripts are installing.</p>
<p>Note that we make the package <code class="docutils literal notranslate"><span class="pre">clang</span></code> in the main material agree in version
with our output version. This is implicitly the same as the top-level
recipe. The <code class="docutils literal notranslate"><span class="pre">clang</span></code> package sets no environment variables at all, so it
may be difficult to use directly.</p>
</li>
<li><p class="first">Let's examine the script <code class="docutils literal notranslate"><span class="pre">install-clang.sh</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

set -e -x

CHOST=${macos_machine}

mkdir -p &quot;${PREFIX}&quot;/etc/conda/{de,}activate.d/
cp &quot;${SRC_DIR}&quot;/activate-clang.sh &quot;${PREFIX}&quot;/etc/conda/activate.d/activate_&quot;${PKG_NAME}&quot;.sh
cp &quot;${SRC_DIR}&quot;/deactivate-clang.sh &quot;${PREFIX}&quot;/etc/conda/deactivate.d/deactivate_&quot;${PKG_NAME}&quot;.sh

pushd &quot;${PREFIX}&quot;/bin
  ln -s clang ${CHOST}-clang
popd
</pre></div>
</div>
<p>Nothing here is too unusual.</p>
<p>Activate scripts are named according to our package name so they won't
conflict with other activate scripts.</p>
<p>The symlink for Clang is a Clang implementation detail that sets the host
platform.</p>
<p>We define <code class="docutils literal notranslate"><span class="pre">macos_machine</span></code> in aggregate's <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code>:
<a class="reference external" href="https://github.com/AnacondaRecipes/aggregate/blob/master/conda_build_config.yaml#L79">https://github.com/AnacondaRecipes/aggregate/blob/master/conda_build_config.yaml#L79</a></p>
<p>The activate scripts that are being installed are where we actually set the
environment variables. Remember that these have been modified by build.sh.</p>
</li>
<li><p class="first">With any of your desired changes in place, go ahead and build the recipe.</p>
<p>You should end up with a super_duper_clang_osx-64 package. Or, if you're not
on macOS and are modifying a different recipe, you should end up with an
equivalent package for your platform.</p>
</li>
</ol>
</div>
<div class="section" id="using-your-customized-compiler-package-with-conda-build-3">
<span id="id1"></span><h2>Using your customized compiler package with conda-build 3<a class="headerlink" href="#using-your-customized-compiler-package-with-conda-build-3" title="Permalink to this headline">¶</a></h2>
<p>Remember the Jinja2 function, <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">compiler('c')</span> <span class="pre">}}</span></code>? Here's where that comes
in. Specific keys in <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> are named for the language
argument to that jinja2 function. In your <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code>, add
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_compiler</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">super_duper_clang</span>
</pre></div>
</div>
<p>Note that we're not adding the <code class="docutils literal notranslate"><span class="pre">target_platform</span></code> part, which is separate. You
can define that key, too:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_compiler</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">super_duper_clang</span>
<span class="n">target_platform</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">win</span><span class="o">-</span><span class="mi">64</span>
</pre></div>
</div>
<p>With those two keys defined, conda-build will try to use a compiler package
named <code class="docutils literal notranslate"><span class="pre">super_duper_clang_win-64</span></code>. That package needs to exist for your native
platform. For example, if you're on macOS, your native platform is <code class="docutils literal notranslate"><span class="pre">osx-64</span></code>.</p>
<p>The package subdirectory for your native platform is the build platform. The
build platform and the <code class="docutils literal notranslate"><span class="pre">target_platform</span></code> can be the same, and they are the
same by default, but they can also be different. When they are different,
you're cross-compiling.</p>
<p>If you ever needed a different compiler key for the same language, remember
that the language key is arbitrary. For example, we might want different
compilers for Python and for R within one ecosystem. On Windows, the Python
ecosystem uses the Microsoft Visual C compilers, while the R ecosystem uses the
Mingw compilers.</p>
<p>Let's start in <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python_c_compiler</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">vs2015</span>
<span class="n">r_c_compiler</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">m2w64</span><span class="o">-</span><span class="n">gcc</span>
<span class="n">target_platform</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">win</span><span class="o">-</span><span class="mi">64</span>
</pre></div>
</div>
<p>In Python recipes, you'd have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">build</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">compiler</span><span class="p">(</span><span class="s1">&#39;python_c&#39;</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>In R recipes, you'd have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">build</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">compiler</span><span class="p">(</span><span class="s1">&#39;r_c&#39;</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>This example is a little contrived, because the <code class="docutils literal notranslate"><span class="pre">m2w64-gcc_win-64</span></code> package is
not available. You'd need to create a metapackage <code class="docutils literal notranslate"><span class="pre">m2w64-gcc_win-64</span></code> to
point at the <code class="docutils literal notranslate"><span class="pre">m2w64-gcc</span></code> package, which does exist on the msys2 channel on
<a class="reference external" href="https://repo.anaconda.com/">repo.anaconda.com</a>.</p>
</div>
<div class="section" id="anaconda-compilers-implicitly-add-rpath-pointing-to-the-conda-environment">
<h2>Anaconda compilers implicitly add RPATH pointing to the conda environment<a class="headerlink" href="#anaconda-compilers-implicitly-add-rpath-pointing-to-the-conda-environment" title="Permalink to this headline">¶</a></h2>
<p>You might want to use the Anaconda compilers outside of <code class="docutils literal notranslate"><span class="pre">conda-build</span></code>
so that you use the same versions, flags, and configuration, for maximum
compatibility with Anaconda packages (but in a case where you want simple
tarballs, for example). In this case, there is a gotcha.</p>
<p>Even if Anaconda compilers are used from outside of <code class="docutils literal notranslate"><span class="pre">conda-build</span></code>, the GCC
specs are customized so that, when linking an executable or a shared library,
an RPATH pointing to <code class="docutils literal notranslate"><span class="pre">lib/</span></code> inside the current enviroment prefix directory
(<code class="docutils literal notranslate"><span class="pre">$CONDA_PREFIX/lib</span></code>) is added. This is done by changing the
<code class="docutils literal notranslate"><span class="pre">link_libgcc:</span></code> section inside GCC <code class="docutils literal notranslate"><span class="pre">specs</span></code> file, and this change is done
so that <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> isn't required for basic libraries.</p>
<p><code class="docutils literal notranslate"><span class="pre">conda-build</span></code> knows how to make this automatically relocatable, so that
this <code class="docutils literal notranslate"><span class="pre">RPATH</span></code> will be changed to point to the environment where the package
is being installed (at installation time, by <code class="docutils literal notranslate"><span class="pre">conda</span></code>). But if you only pack
this binary in a tarball, it will continue containing this hardcoded <code class="docutils literal notranslate"><span class="pre">RPATH</span></code>
to an environment in your machine. In this case, it is recommended to manually
remove the <code class="docutils literal notranslate"><span class="pre">RPATH</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="define-metadata.html" class="btn btn-neutral float-right" title="Defining metadata (meta.yaml)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="build-scripts.html" class="btn btn-neutral float-left" title="Build scripts (build.sh, bld.bat)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Anaconda, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>